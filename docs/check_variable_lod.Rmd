---
title: "Variable Limits of Detection"
author: "Report Author"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
targets::tar_source("./packages.R")
tar_source("R")


knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width = 8, 
                      fig.height = 6, 
                      dpi = 600,
                      dev = "ragg_png")
```

```{r}
#| label: load-dependencies
tar_load(c(vl_cor_diff_all,
           vl_na_perc
))
```

## Check Dynamic Ranges in Real Data

```{r}
#| label: load-real-data
tar_load(c(nsclc_counts_info,
           ratstamina_counts_info,
           yeast_counts_info,
           adenocarcinoma_counts_info))
```

```{r}
#| label: check-ranges
counts_list = list(nsclc = nsclc_counts_info$counts,
                   rat = ratstamina_counts_info$counts,
                   yeast = yeast_counts_info$counts,
                   adeno = adenocarcinoma_counts_info$counts)
actual_dr = purrr::map(counts_list, \(in_counts){
  seq_sample = seq_len(ncol(in_counts))
  all_dr = purrr::map_dbl(seq_sample, \(in_sample){
    tmp_counts = in_counts[, in_sample]
    log_counts = log10(tmp_counts[tmp_counts > 0])
    tmp_range = range(log_counts)
    tmp_range[2] - tmp_range[1]
  })
  all_dr
})

purrr::map_dbl(actual_dr, median)
```

## Data Generation

* Base sample, log-normal distribution, `meanlog = 1.5`, `meansd = 0.5`;
* Uniform noise added, at `sd = 0.2`;
* exponentiate, and take $log10$ (so now everything is on an order of magnitude scale, I think);
* Have three levels of trimming we use:
  * low (0 - 0.5);
  * medium (0 - 1);
  * high (0 - 1.5)
* The reason for these ranges, is because of this graph:
  * For values of 0 - 3, increment in 0.1;
  * Take minimum value for a sample and add the increment value (`oom` on the graph);
  * Use as a cutoff;
  * Count how many values in the sample are below the minimum + `oom`.
  * If we go above **2**, we are cutting out an awful lot of values.
* For each level, generate a uniform distribution of `oom` to add to the minimum in each sample on the range for that **level** (see above);
* Values in each sample below the values defined are set to `NA`;
* Calculate correlations of the original data with no missing, and then with missing;
* Compare them.


```{r}
#| label: fig-check-lod-na
vl_na_perc |>
  ggplot(aes(x = oom, y = sample_na, group = oom)) +
  geom_sina() +
  geom_vline(xintercept = c(0.5, 1, 1.5), color = "red")
```

Number of values that get set to `NA` using different order of magnitude cutoffs in 100 samples.
Red lines indicate three levels chosen for the below experiment of 0.5, 1, and 1.5, respectively.

## Reference vs LOD Correlation Differences

```{r}
#| label: fig-lod-diffs
#| fig-width: 12
#| fig-height: 8
vl_cor_diff_all |>
  dplyr::mutate(oom_id = factor(oom_id, levels = c("low", "med", "high"))) |>
  dplyr::filter(cor_method %in% c("icikt", "pearson_min")) |>
  ggplot(aes(x = ref_v_lod, y = cor_method)) +
  geom_sina(size = 1) +
  facet_wrap(~ oom_id, ncol = 1) +
  labs(x = "Reference vs LOD Correlation Differences", y = "Method")
```

Sina plots of reference correlation - limit of detection correlation for ICI-Kt and Pearson after dataset wide imputation using a value of 1/2 the minimum, with different maximum order of magnitude cutoffs of 0.5 (low), 1 (med), and 1.5 (high).

```{r}
#| label: fig-lod-diffs2
#| fig-width: 12
#| fig-height: 8
vl_cor_diff_all |>
  dplyr::mutate(oom_id = factor(oom_id, levels = c("low", "med", "high"))) |>
  dplyr::filter(cor_method %in% c("icikt", "pearson_min")) |>
  ggplot(aes(x = ref_v_lod_relative, y = cor_method)) +
  geom_sina(size = 1) +
  facet_wrap(~ oom_id, ncol = 1) +
  labs(x = "Relative Reference vs LOD Correlation Differences", y = "Method")
```

Sina plots of relative reference correlation - limit of detection correlation for ICI-Kt and Pearson after dataset wide imputation using a value of 1/2 the minimum, with different maximum order of magnitude cutoffs of 0.5 (low), 1 (med), and 1.5 (high).

## Can We Find Patterns In Here?

What happens if we plot the differences of ICI-Kt and Pearson-Min to each other, and color the points by the maximum number of `NA` values in the two samples being correlated?

```{r}
#| label: pattern-values
icikt_min = vl_cor_diff_all |>
  dplyr::filter(cor_method %in% c("icikt", "pearson_min")) |>
  dplyr::mutate(oom_id = factor(oom_id, levels = c("low", "med", "high")))

icikt_min_wider = icikt_min |>
  dplyr::select(oom_id, comparison, ref_v_lod, s1_n_na, s2_n_na, cor_method) |>
  tidyr::pivot_wider(names_from = cor_method, values_from = ref_v_lod) |>
  dplyr::mutate(max_na = dplyr::case_when(
    s1_n_na >= s2_n_na ~ s1_n_na,
    s1_n_na <= s2_n_na ~ s2_n_na
  ))

icikt_min_wider |>
  ggplot(aes(x = icikt, y = pearson_min, color = max_na)) +
  geom_point(alpha = 0.25) +
  scale_color_viridis_b() +
  geom_abline(slope = 1, color = "red") +
  geom_abline(slope = -1, color = "red") +
  facet_wrap(~ oom_id, ncol = 1, scales = "free")
```

ICI-Kt vs Pearson-Min reference correlation - lod correlation, colored by the maximum number of `NA` values observed in the two samples being correlated, by level of order of magnitude limits of detection.


```{r}
#| label: abs-diff
icikt_min_wider |>
  ggplot(aes(x = abs(icikt), y = abs(pearson_min), color = max_na)) +
  geom_point(alpha = 0.25) +
  scale_color_viridis_b() +
  geom_abline(slope = 1, color = "red") +
  facet_wrap(~ oom_id, ncol = 1, scales = "free")
```
ICI-Kt vs Pearson-Min abs(reference correlation - lod correlation), colored by the maximum number of `NA` values observed in the two samples being correlated, by level of order of magnitude limits of detection.

```{r}
#| label: abs-diff-hist
icikt_min_wider |>
  ggplot(aes(x = abs(icikt) - abs(pearson_min))) +
  geom_histogram(bins = 100) +
  geom_vline(xintercept = 0, color = "red") +
  facet_wrap(~ oom_id, ncol = 1, scales = "free_y")
```

abs(ICI-Kt) - abs(Pearson-Min) (reference correlation - lod correlation) histogram by level of order of magnitude limits of detection.
