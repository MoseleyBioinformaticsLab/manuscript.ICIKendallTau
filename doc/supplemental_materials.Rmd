---
title: 'Supplemental Materials'
author: 'Robert M Flight, Praneeth S Bhatt, and Hunter NB Moseley'
date: '`r Sys.time()`'
output: 
  rmarkdown::word_document:
    keep_md: true
bibliography: '`r here::here("doc/icikt_references.json")`'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, 
                      message = FALSE, fig.width = 8, 
                      fig.height = 6, fig.keep = "all",
                      fig.process = dn_modify_path,
                      tab.cap.style = "paragraph",
                      tab.cap.pre = "",
                      tab.cap.sep = "",
                      dpi = 600,
                      dev.args = list(png = list(type = "cairo")))


supp_figure_count = dn_counter$new("Figure S", "_")
supp_table_count = dn_counter$new("Table S", "_")

supp_figure_count$increment("kt_pearson")
supp_figure_count$increment("ici_distribution")
supp_figure_count$increment("kt_distribution")
```

## Simulated Data

The simplest simulated data set includes three samples, where two are perfectly correlated, and the third perfectly anti-correlated. 
We then created missing values (replaced value with NA) in each sample systematically, and computed the ICI-Kt, Pearson, and Kendall-tau correlations.

```{r compare_simple, dn_id = supp_figure_count$label_file("kt_pearson")}
loadd(positive_kt)
loadd(positive_pearson)
loadd(negative_kt)
loadd(negative_pearson)

all_kt = rbind(positive_kt, negative_kt)
all_pearson = rbind(positive_pearson, negative_pearson)
all_pearson[is.na(all_pearson$cor), "cor"] = 0

compare_df = data.frame(ici_kt = all_kt$cor,
                        pearson = all_pearson$cor)
set.seed(1234)
rand_rows = sample(nrow(compare_df), 10000)
compare_df2 = compare_df[rand_rows, ]
ggplot(compare_df2, aes(x = pearson, y = ici_kt)) + 
  geom_point() +
  labs(x = "Pearson", y = "ICI-Kt")
```

`r supp_figure_count$label_text("kt_pearson")`. Comparison of ICI-Kt and Pearson correlations for perfectly positive and negatively correlated samples, systematically replacing values with NA.
NA values from Pearson were replaced with zero for this comparison.

We can also examine the full set of positive and negative correlations generated as we vary the number of missing entries between two positively correlated samples and two negatively correlated samples.
These distributions are shown in `r supp_figure_count$label_text("kt_distribution")`.
We can see that the distributions from both ICI-Kt and Kendall-tau are the same, which is expected given we replaced missing values (NA) with zero *within* the ICI-Kt code, and replaced missing values (NA) with zero prior to calculating Kendall-tau correlations.

```{r ici_full_distribution, dn_id = supp_figure_count$label_file("ici_distribution")}
loadd(all_kt)
ici_plot = ggplot(all_kt, aes(x = ici_kt)) +
  geom_histogram(bins = 100) +
  facet_wrap(~ comp, ncol = 1) +
  labs(x = "ICI-Kt Correlation", y = "count")
ici_plot
```

`r supp_figure_count$label_text("ici_distribution")`.
ICI-Kendall-tau correlation as missing values are varied between two samples.

```{r kt_full_distribution, dn_id = supp_figure_count$label_file("kt_distribution")}
kt_plot = ggplot(all_kt, aes(x = kendall)) +
  geom_histogram(bins = 100) +
  facet_wrap(~ comp, ncol = 1) +
  labs(x = "Kendall-tau Correlation", y = "count")
kt_plot
```

`r supp_figure_count$label_text("kt_distribution")`.
Kendall-tau correlation as missing values are varied between two samples and replaced with 0 before calculating Kendall-tau.

## Algorithmic Complexity

```{r increment_count_complexity}
supp_figure_count$increment("complexity")
```

In addition to comparing their performance, we can check that the algorithmic complexity fits the theoretically expected complexity by fitting a regression line of the run time to the number of items.
The run times and fitted lines for each method (R's Pearson, the ICI-Kt, and R's Kendall-tau) are shown in `r supp_figure_count$label_text("complexity")`.

```{r plot_complexity, dn_id = supp_figure_count$label_file("complexity")}
single_core_perf = readRDS(here::here("doc", "single_core_perf.rds"))
complex_figure = create_complexity_figure(single_core_perf)
complex_figure
```

`r supp_figure_count$label_text("complexity")`. 
Time in seconds needed as a function of the number of features, with a fitted line for the assumed complexity for each of the methods tested, including R's Pearson correlation, the ICI-Kt mergesort, and R's Kendall-tau correlation algorithm.


## Outlier Samples

### Gierlinski Yeast

Gierlinski et al [@gierlinski_statisticalmodels_2015] proposed a combination of median sample-sample correlation, gene count outlier fraction, and a chi-square test of read coverage per gene to score each biological replicate from a group of samples.
Outside of defining this combined score, they do not describe the actual criteria of saying a replicate is "bad".
In this work, we used **only** the sample-sample median correlation to identify "bad" or "outlier" samples, using the boxplot.stats function to determine outliers, where an outlier is defined as samples that are > 1.5x away from the limits of the box defining the distribution.

Here, we calculated Pearson correlation using the raw counts, and with only those genes that had non-zero reads in both samples.
This version of Pearson correlation recreates the median sample-sample correlations observed in the original report.

Finally, we note the actual samples recorded as outliers by Gierlinski and coworkers, noted as "Manuscript".

```{r load_yeast_outliers}
supp_figure_count$increment("yeast_outliers")
manual_method = c("icikt" = "IK",
                                                 "icikt_complete" = "IKC",
                                                 "pearson_base" = "PB",
                                                 "pearson_base_nozero" = "PN0",
                                                 "pearson_log1p" = "PL1",
                                                 "pearson_log" = "PL",
                                                 "kt_base" = "Kt",
                                                 "manuscript" = "M")

other_method = c("icikt" = "IK",
                                                 "icikt_complete" = "IKC",
                                                 "pearson_base" = "PB",
                                                 "pearson_base_nozero" = "PN0",
                                                 "pearson_log1p" = "PL1",
                                                 "pearson_log" = "PL",
                                                 "kt_base" = "Kt")

loadd(yeast_paper_outliers)

all_yeast = purrr::map_df(c("yeast_outliers_1",
                            "yeast_outliers_25",
                            "yeast_outliers_50"), function(.x){
                              tmp = readd(.x, character_only = TRUE)
                              tmp$outliers
                            }) %>%
  perc_to_number()

all_yeast = add_method(all_yeast)

yeast_single = all_yeast %>%
  dplyr::select(-method) %>%
  dplyr::filter(keep_num == "1")
tmp_yeast = yeast_single %>%
  dplyr::filter(which %in% "pearson_base_nozero")
tmp_yeast$outlier = FALSE
tmp_yeast[tmp_yeast$sample_id %in% yeast_paper_outliers, "outlier"] = TRUE
tmp_yeast$which = "manuscript"
yeast_single2 = rbind(yeast_single, tmp_yeast)

compare_yeast = c("icikt", "icikt_complete", "pearson_log1p", "pearson_base_nozero", "manuscript")
```

```{r yeast_single_plot, dn_id = supp_figure_count$label_file("yeast_outliers")}
yeast_single2 %>%
  add_method(map_method = manual_method) %>%
  dplyr::filter(which %in% compare_yeast) %>%
  ggplot(aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) +
  geom_sina() +
  facet_wrap(~ method, nrow = 1) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("yeast_outliers")`.
Median correlations for each of the yeast RNA-Seq sample to all other samples in the same group, using different correlation measures on different data. Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; M: Manuscript; PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.


```{r yeast_outlier_table}
yeast_table = compare_outlier_tables(yeast_single2, compare_yeast, sort_var = "manuscript", map_method = manual_method)

supp_table_count$increment("yeast_outliers")
```

`r supp_table_count$label_text("yeast_outliers")`.
Yeast dataset median correlation values and outlier determination for each outlier from each of the correlation methods.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; M: Manuscript; PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

```{r yeast_table2}
#yeast_ft_out = set_caption(yeast_table,
  # caption = paste0(paste_label("Table S", supp_table_count, "yeast_outliers"), ". Yeast dataset median correlation values and outlier determination for each outlier from each of the correlation methods."), style = "paragraph")
yeast_ft_out = autofit(yeast_table)
yeast_ft_out
```

In `r supp_figure_count$label_text("yeast_outliers")` and `r supp_table_count$label_text("yeast_outliers")` we can see how the determination of outliers was not made solely on the basis of correlation alone, but on a combination of factors that lead to some of the higher correlating samples (using raw counts and Pearson correlaion) being considered outliers where lower correlating samples were not listed as being outliers.

Regardless, using ICI-Kt or ICI-Kt * Completeness in this instance, the outliers using the simple distribution summary statistics and an outlier having to be > 1.5 median error, the outliers are mostly a superset of the outliers determined by Gierlinski et al, with the exception of three samples specific to their data: Snf2.24, WT.22, and WT.28.

It should be noted that it seems that Gierlinski et al used an eyeball cutoff for the outliers based on the combined score of correlation, outlier fraction, and read coverage chi-square fitness, with samples having a combined log-score > -2.8 (evaluated by RMF eyeball on a zoomed in graph and a ruler), a value that is never stated in the manuscript, and which seems arbitrary from the data.

## Brainson RNASeq Samples

```{r brainsonrnaseq_load}
supp_figure_count$increment("brainson_outliers")
supp_table_count$increment("brainson_outliers")
all_brainson = purrr::map_df(c("brainsonrnaseq_outliers_1",
                            "brainsonrnaseq_outliers_25",
                            "brainsonrnaseq_outliers_50",
                            "brainsonrnaseq_outliers_75",
                            "brainsonrnaseq_outliers_100"), function(.x){
                              tmp = readd(.x, character_only = TRUE)
                              tmp$outliers
                            }) %>%
  perc_to_number()

brainson_single = all_brainson %>%
  dplyr::filter(keep_num == "1")
compare_brainson = c("icikt", "icikt_complete", "pearson_log1p")
```

```{r show_brainson, dn_id = supp_figure_count$label_file("brainson_outliers")}
brainson_single %>%
  add_method() %>%
  dplyr::filter(which %in% compare_brainson) %>%
  ggplot(aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) +
  geom_sina() +
  facet_wrap(~ method, nrow = 1) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("brainson_outliers")`.
Median correlations for each of the Brainson RNA-Seq sample to all other samples in the same group, using different correlation measures on different data. 

`r supp_figure_count$label_text("brainson_outliers")` shows the effect of including the pairwise completeness measure, where the "total" tumor samples have a higher correlation than the "sorted" samples where a specific subset of cells were collected from each sample and sequenced.
This is due to having more genes with non-zero reads in general over the sorted samples.

`r supp_table_count$label_text("brainson_outliers")`.
Brainson dataset median correlation values and outlier determination for each outlier from each of the correlation methods.

```{r brainson_table}
brainson_table = compare_outlier_tables(brainson_single, compare_brainson, "pearson_log1p")
autofit(brainson_table)
```


`r supp_table_count$label_text("brainson_outliers")` indicates the outliers determined with each correlation method.
Discussions with the Brainson group have determined that some of the samples in the sorted group were run on different days with different technicians, which may explain the two sorted outliers.

## TCGA Adenocarcinoma

```{r adeno_load}
supp_figure_count$increment("adeno_outliers")
supp_table_count$increment("adeno_outliers")

all_adeno = purrr::map_df(c("adeno_outliers_1",
                            "adeno_outliers_25",
                            "adeno_outliers_50"), function(.x){
                              tmp = readd(.x, character_only = TRUE)
                              tmp$outliers
                            }) %>%
  perc_to_number()

new_adeno = unique(all_adeno[, c("sample_id", "sample_class")]) %>%
  dplyr::mutate(sample_seq = seq(1, n()),
                sample_new = dplyr::case_when(
    sample_class %in% "Tumor" ~ paste0("T.", sample_seq),
    TRUE ~ paste0("N.", sample_seq)
  )) %>%
  dplyr::mutate(old_sample = sample_id,
                sample_seq = NULL,
                sample_class = NULL,
                sample_id = sample_new,
                sample_new = NULL)

all_adeno2 = dplyr::left_join(new_adeno, all_adeno, by = c("old_sample" = "sample_id"))

adeno_single = all_adeno2 %>%
  dplyr::filter(keep_num == "1")
compare_adeno = c("icikt", "icikt_complete", "pearson_log1p")
```

```{r show_adeno_outliers, dn_id = supp_figure_count$label_file("adeno_outliers")}
adeno_single %>%
  add_method() %>%
  dplyr::filter(which %in% compare_adeno) %>%
  ggplot(aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) +
  geom_sina() +
  facet_wrap(~ method, nrow = 1) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("adeno_outliers")`.
TCGA Adenocarcinoma outliers using various measures of correlation.

`r supp_table_count$label_text("brainson_outliers")`.
Brainson dataset median correlation values and outlier determination for each outlier from each of the correlation methods.

```{r adeno_table}
adeno_table = compare_outlier_tables(adeno_single, compare_adeno, "pearson_log1p")
autofit(adeno_table)
```

```{r summarize_adeno}
supp_table_count$increment("adeno_mad")
adeno_variation = adeno_single %>%
  add_method() %>%
  dplyr::filter(which %in% compare_adeno) %>%
  calculate_variation() %>%
  dplyr::select(mad) 

adeno_ratios = adeno_variation %>%
  tidyr::pivot_wider(names_from = sample_class, values_from = mad) %>%
  dplyr::summarise(ratio = format(Tumor / Normal, digits = 0)) %>%
  tidyr::pivot_wider(names_from = method, values_from = ratio)
adeno_variation_wide = adeno_variation %>% 
  tidyr::pivot_wider(names_from = sample_class, values_from = mad) %>%
  flextable() %>%
  colformat_double(digits = 3) %>%
  autofit() 
```

`r supp_table_count$label_text("adeno_mad")`.
Adenocarcinoma median-absolute-deviations (MAD) for each group of sample median correlations in each type of tissue.

```{r summarize_adeno2}
# %>%
#   set_caption(caption = paste0(paste_label("Table S", supp_table_count, "adeno_mad"), ". Adenocarcinoma median-absolute-deviations (MAD) for each group of sample median correlations in each type of tissue."), style = "paragraph")
autofit(adeno_variation_wide)
```

As `r supp_figure_count$label_text("adeno_outliers")` and `r supp_table_count$label_text("adeno_outliers")`, although there are not many outliers in these relatively large groups, Pearson correlation using log-transformed values results in the most outliers.
Also of note is that ICI-Kt * Completeness is the only measure where the variance measure for both groups is similar.
For both ICI-Kt and Pearson correlation, the tumor samples variance measures are `r adeno_ratios[["ICI-Kt"]]`x and `r adeno_ratios[["Pearson Log(x + 1)"]]`x greater than normal, respectively.


## Effect of Increasing Presence in Samples

One sure way to limit the effect of missing values on correlation values is to impose the condition that a gene has a non-zero count in a minimum percentage of the samples in one of the classes.
In all of the example plots above, and the tables in the main manuscript text, a gene had to be present in at least **one sample**.
Here, we explore what happens if we increase the number of samples required for a gene to be present in at 25% and 50% of a class for the yeast samples and adenocarcinoma samples, and 25%, 50%, 75% and all samples of a class for the Brainson samples.
We also examine the effect using all possible correlation measures.

### Yeast Samples

```{r increment_count_yeast}
supp_figure_count$increment("yeast_by_method")
supp_figure_count$increment("yeast_by_keep_num")
supp_figure_count$increment("yeast_differences")
```

```{r yeast_by_method, dn_id = supp_figure_count$label_file("yeast_by_method")}
all_yeast2 = all_yeast %>%
  add_method(other_method) %>%
  clear_outliers()
ggplot(all_yeast2, aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) + 
  geom_sina() +
  facet_grid(keep_num ~ method) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("yeast_by_method")`.
Median correlations by correlation method and applying different fractional cutoffs.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

```{r yeast_by_fraction, dn_id = supp_figure_count$label_file("yeast_by_keep_num")}
ggplot(all_yeast2, aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) +
  geom_sina() +
  facet_grid(method ~ keep_num) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("yeast_by_keep_num")`.
Median correlations by applying different fractional cutoffs and different correlation methods.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

```{r yeast_plot_differences, dn_id = supp_figure_count$label_file("yeast_differences")}
yeast_summary = calculate_variation(all_yeast2)
yeast_diffs = calculate_differences(yeast_summary)

ggplot(yeast_diffs, aes(x = keep_num, y = diff)) + 
  geom_col() +
  facet_grid(which_diff ~ method) +
  labs(x = "Keep Fraction", y = "WT / Snf2 Differences") +
  theme(axis.text.x = element_text(angle = 90))
```

`r supp_figure_count$label_text("yeast_differences")`.
Difference between WT and Snf2 group medians and MAD for the different correlation methods and gene presence fractions.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

### Brainson Samples

```{r increment_count_brainson}
supp_figure_count$increment("brainson_by_method")
supp_figure_count$increment("brainson_by_keep_num")
supp_figure_count$increment("brainson_differences")
```

```{r brainson_plot1, dn_id = supp_figure_count$label_file("brainson_by_method")}
brainson_classes = c("sorted", "total")
all_brainson_method = add_method(all_brainson, map_method = other_method) %>%
  dplyr::filter(sample_class %in% brainson_classes)
ggplot(all_brainson_method, aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) + 
  geom_sina() +
  facet_grid(keep_num ~ method) +
  theme(axis.text.x = element_text(size = 10)) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("brainson_by_method")`.
Median correlations by correlation method and applying different fractional cutoffs for Brainson RNA-seq data.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

```{r brainson_plot2, dn_id = supp_figure_count$label_file("brainson_by_keep_num")}
ggplot(all_brainson_method, aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) + 
  geom_sina() +
  facet_grid(method ~ keep_num) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("brainson_by_keep_num")`.
Median correlations by correlation method and applying different fractional cutoffs for Brainson RNA-seq data.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

```{r brainson_plot_differences, dn_id = supp_figure_count$label_file("brainson_differences")}
brainson_summary = calculate_variation(all_brainson_method)
brainson_diffs = calculate_differences(brainson_summary)

ggplot(brainson_diffs, aes(x = keep_num, y = diff)) + 
  geom_col() +
  facet_grid(which_diff ~ method) +
  labs(x = "Keep Fraction", y = "Sorted / Total Differences") +
  theme(axis.text.x = element_text(angle = 90))
```

`r supp_figure_count$label_text("brainson_differences")`.
Difference between sorted and total sample group medians and MAD for the different correlation methods and gene presence fractions.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

### Adenocarcinoma

```{r increment_count_adeno}
supp_figure_count$increment("adeno_by_method")
supp_figure_count$increment("adeno_by_keep_num")
supp_figure_count$increment("adeno_differences")
```

```{r adeno_by_method, dn_id = supp_figure_count$label_file("adeno_by_method")}
adeno_method = add_method(all_adeno2, other_method) %>%
  clear_outliers()
ggplot(adeno_method, aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) + 
  geom_sina() +
  facet_grid(keep_num ~ method) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("adeno_by_method")`. 
Median correlations by correlation method and applying different fractional cutoffs for TCGA adenocarcinoma RNA-seq data.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

```{r adeno_by_fraction, dn_id = supp_figure_count$label_file("adeno_by_keep_num")}
ggplot(adeno_method, aes(x = sample_class, y = med_cor, color = outlier, group = sample_class)) +
  geom_sina() +
  facet_grid(method ~ keep_num) +
  labs(x = "Sample Class", y = "Median Correlation")
```

`r supp_figure_count$label_text("adeno_by_keep_num")`. 
Median correlations by correlation method and applying different fractional cutoffs for TCGA adenocarcinoma RNA-seq data.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

```{r adeno_plot_differences, dn_id = supp_figure_count$label_file("adeno_differences")}
adeno_summary = calculate_variation(adeno_method)
adeno_diffs = calculate_differences(adeno_summary)

ggplot(adeno_diffs, aes(x = keep_num, y = diff)) + 
  geom_col() +
  facet_grid(which_diff ~ method) +
  labs(x = "Keep Fraction", y = "Normal / Tumor Differences") +
  theme(axis.text.x = element_text(angle = 90))
```

`r supp_figure_count$label_text("adeno_differences")`. 
Difference of normal and tumor medians and MADs  by correlation method and applying different fractional cutoffs for TCGA adenocarcinoma RNA-seq data.
Abbreviations for different measures and data are: IK: ICI-Kt; IKC: ICI-Kt * Completeness; Kt: Kendall-tau; PB: Pearson Base (raw values); PL: Pearson Log(x); PL1: Pearson Log(x + 1); PN0: Pearson No Zeros.

## References
