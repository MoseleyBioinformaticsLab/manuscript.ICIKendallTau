---
title: 'Verifying the Problem'
output: 
  rmarkdown::word_document:
    keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, 
                      message = FALSE, fig.width = 8, 
                      fig.height = 10, fig.keep = "all",
                      tab.cap.style = "paragraph",
                      tab.cap.pre = "",
                      tab.cap.sep = "",
                      dpi = 600,
                      dev.args = list(png = list(type = "cairo")))
```

## Yeast

```{r}
#| label: yeast_check
source(here::here("packages.R"))
suppressMessages(library(DESeq2))
loadd(yeast_counts_info)
yeast_counts = yeast_counts_info$counts

yeast_des = DESeqDataSetFromMatrix(yeast_counts_info$counts, yeast_counts_info$info, design = ~ sample)
yeast_des = estimateSizeFactors(yeast_des)
yeast_norm = counts(yeast_des, normalized = TRUE)

yeast_counts_df = tibble::as_tibble(yeast_norm)
yeast_counts_df$feature = rownames(yeast_norm)

yeast_counts_long = yeast_counts_df |>
  tidyr::pivot_longer(cols = -feature, names_to = "sample", values_to = "count")
yeast_counts_long = dplyr::left_join(yeast_counts_long, yeast_counts_info$info, by = c("sample" = "sample_rep"))

# yeast_counts_long |>
#   ggplot(aes(x = sample, y = log2(count))) +
#   geom_boxplot()

yeast_median = yeast_counts_long |>
  dplyr::group_by(sample.y, feature) |>
  dplyr::summarise(median = median(count),
                   median_present = median(count[count > 0]),
                   n_present = sum(count > 0)) |>
  dplyr::ungroup()

yeast_plots = list(all = 
                     yeast_median |>
                     ggplot(aes(x = log2(median_present), y = n_present)) +
                     geom_point(),
                   
                   less_32 = 
                     yeast_median |>
                     dplyr::filter(median_present < 32) |>
                     ggplot(aes(x = log2(median_present), y = n_present)) +
                     geom_point())

wrap_plots(yeast_plots, ncol = 1)
yeast_test_cor = yeast_median |>
  dplyr::filter(median_present <= 32)
cor.test(yeast_test_cor$median_present, yeast_test_cor$n_present, method = "kendall")
```

So here I've taken the Gierlinski Yeast data set, normalized it, and then counted how many samples a value was present in, and what the median value was across all samples (all) and where present (present).

I trimmed to a median_present <= 32, and then run a correlation test between # samples present and median_present using Kendall-tau.

So definitely a relationship in this case.

Will be doing up the rest this morning.

## Brainson

```{r}
#| label: load_brainson
loadd(brainsonrnaseq_counts)
loadd(brainsonrnaseq_info)
```

```{r}
#| label: process_brainson
brainsonrnaseq_des = DESeqDataSetFromMatrix(round(brainsonrnaseq_counts), brainsonrnaseq_info, design = ~ tumor + type) 
brainsonrnaseq_des = estimateSizeFactors(brainsonrnaseq_des)
brainsonrnaseq_norm = counts(brainsonrnaseq_des, normalized = TRUE)

brainsonrnaseq_norm_df = tibble::as_tibble(brainsonrnaseq_norm) |>
  dplyr::mutate(feature = rownames(brainsonrnaseq_norm))

brainsonrnaseq_norm_long = brainsonrnaseq_norm_df |>
  tidyr::pivot_longer(-feature,
                      values_to = "count",
                      names_to = "sample")

brainsonrnaseq_norm_long = dplyr::left_join(brainsonrnaseq_norm_long,
                                            brainsonrnaseq_info, by = "sample")

brainsonrnaseq_median = brainsonrnaseq_norm_long |>
  dplyr::group_by(type, tumor, feature) |>
  dplyr::summarise(median = median(count),
                   median_present = median(count[count > 0]),
                   n_present = sum(count > 0)) |>
  dplyr::ungroup()


brainsonrnaseq_plots = list(all = 
                     brainsonrnaseq_median |>
                     ggplot(aes(x = log2(median), y = n_present)) +
                     geom_point(),
                   
                   less_32 = 
                     brainsonrnaseq_median |>
                     dplyr::filter(median < 32) |>
                     ggplot(aes(x = log2(median), y = n_present)) +
                     geom_point())

wrap_plots(brainsonrnaseq_plots, ncol = 1)
brainsonrnaseq_test_cor = brainsonrnaseq_norm_median |>
  dplyr::filter(median_present <= 32)
cor.test(brainsonrnaseq_test_cor$median_present, brainsonrnaseq_test_cor$sample_present, method = "kendall")
```


## NSCLC Metabolomics

```{r}
#| label: load_nsclc
nsclc_peaks = readRDS("data/nsclc_matched_height.rds")
loadd(nsclc_medians)
loadd(nsclc_info)

keep_samples = intersect(colnames(nsclc_peaks), nsclc_medians$sample)
keep_samples = intersect(keep_samples, nsclc_info$sample)

nsclc_info = nsclc_info |>
  dplyr::filter(sample %in% keep_samples) |>
  dplyr::mutate(disease_instrument = paste0(disease, ":", instrument))
split_type_instrument = split(nsclc_info, nsclc_info$disease_instrument)

nsclc_medians = nsclc_medians |>
  dplyr::filter(sample %in% keep_samples)

nsclc_peaks = nsclc_peaks[, keep_samples]

nsclc_norm_list = purrr::map(colnames(nsclc_peaks), function(.x){
  nsclc_peaks[, .x] / (dplyr::filter(nsclc_medians, sample %in% .x) |> dplyr::pull(median))
})

nsclc_norm = do.call(cbind, nsclc_norm_list)
colnames(nsclc_norm) = colnames(nsclc_peaks)
nsclc_norm[is.na(nsclc_norm)] = 0

nsclc_median_instrument = purrr::map(split_type_instrument, function(in_instrument){
  tmp_norm = nsclc_norm[, in_instrument$sample]
  instrument_median = purrr::map_dfr(seq_len(nrow(nsclc_norm)), function(in_feature){
    tmp_data = tmp_norm[in_feature, ]
    med_all = median(tmp_data)
    tmp_not0 = tmp_data[tmp_data > 0]
    if (length(tmp_not0) > 0) {
      med_not0 = median(tmp_not0)
      return(
        tibble(feature = in_feature, sample_present = length(tmp_not0), sample_missing = length(tmp_data) - length(tmp_not0), median_all = med_all, median_present = med_not0, disease_instrument = in_instrument$disease_instrument[1])
      )
    } else {
      return(NULL)
    }
    
  })
  instrument_median
})

nsclc_by_instrument = purrr::map(nsclc_median_instrument, function(.x){
  tmp_x = .x |>
    dplyr::group_by(sample_present) |>
    dplyr::summarise(med_median_present = median(median_present))
         .x |>
         ggplot(aes(x = log2(median_present), y = sample_present, group = sample_present)) +
geom_sina() +
        labs(subtitle = .x$disease_instrument[1])
})

wrap_plots(nsclc_by_instrument, nrow = 2)
wrap_plots(nsclc_by_instrument$FSN10352, ncol = 1)

cor_tests = purrr::walk(nsclc_median_instrument, function(.x){
  cor_sub = .x |>
    dplyr::filter(median_present < 2)
  print(cor.test(cor_sub$median_present, cor_sub$sample_present, method = "kendall"))
})

cor.test(nsclc_test_cor$median_present, nsclc_test_cor$sample_present, method = "kendall")
```

Sooo, this one is kinda weird.
